# Force-everything pipeline run + apply FixDataset on a new branch and commit .par/.tim
#
# IMPORTANT:
#  - Every path string MUST be quoted in TOML (otherwise tomllib will throw "Invalid value").
#  - Edit the 4 path-ish fields below to match your checkout + container + output directory.

home_dir = "/work/git_projects/data-eptadr3/"
dataset_name = "DR3full"
results_dir = "results"
singularity_image = "/work/git_projects/PSR_Singularity/psrpta.sif"
outdir_name = "run_fixdataset_all_fixes"
pulsars = "ALL"

# Branch workflow:
#  - base branch: where you start (usually main/master)
#  - fix branch: created from base, fixes applied + committed, then pipeline runs on both branches
branches = ["main"]
reference_branch = "main"
make_change_reports = true

# Tempo2 / pipeline execution
run_tempo2 = true
force_rerun = true
jobs = 8
epoch = "auto"   # if your PipelineConfig expects an int/MJD, replace with e.g. "58000"

pqc_backend_col = "group"
pqc_drop_unmatched = false
qc_report = true
qc_report_backend_col = "group"
qc_report_no_plots = false
qc_report_structure_group_cols = "group;sys;freq_bin"
qc_report_no_feature_plots = false

pqc_add_orbital_phase = true
pqc_add_solar_elongation = true
pqc_add_elevation = true
pqc_add_airmass = true
pqc_add_parallactic_angle = true
pqc_add_freq_bin = true
pqc_freq_bins = 20

pqc_structure_mode = "both"
pqc_structure_detrend_features = ["solar_elongation_deg", "orbital_phase", "freq_bin"]
pqc_structure_test_features = ["orbital_phase", "solar_elongation_deg", "freq_bin"]
pqc_structure_nbins = 20
pqc_structure_min_per_bin = 2
pqc_structure_p_thresh = 0.01
pqc_structure_circular_features = ["orbital_phase"]
pqc_structure_group_cols = ["group"]
pqc_outlier_gate_enabled = true
pqc_outlier_gate_sigma = 3.0
pqc_event_instrument = true

pqc_dm_step_enabled = false
pqc_dm_step_min_points = 20
pqc_dm_step_delta_chi2_thresh = 25.0
pqc_dm_step_scope = "both"

pqc_robust_enabled = true
pqc_robust_z_thresh = 2.0
pqc_robust_scope = "both"

# QC -> FixDataset application (comment out by default)
fix_qc_remove_outliers = false
fix_qc_action = "comment"
fix_qc_comment_prefix = "C QC_OUTLIER"
fix_qc_remove_bad = true
fix_qc_remove_transients = false
fix_qc_merge_tol_days = 2.3148148148148147e-05
#2.0 / 86400.0
# If you want to point to a specific run, set these (otherwise auto from fix_branch_name):
# fix_qc_results_dir = "results/run_fixdataset_all_fixes/main-fixdataset_test_5/qc"
# fix_qc_branch = "fixdataset_test_5"


# ---- FixDataset APPLY + COMMIT ----
# These are the settings that should force the apply path (branch + commit) if your pipeline.py supports it.
fix_apply = true
fix_branch_name = "" 
fix_base_branch = "main"
fix_commit_message = "FixDataset: apply all automated fixes"

# Keep the repo clean during branch switching (no *.orig files)
fix_backup = false
fix_dry_run = false

# ---- FixDataset options: turn on every safe fix step ----
# 2) Ensure *_all.tim includes every per-backend tim under <psr>/tims/ (dropping tiny ones)
fix_update_alltim_includes = true
fix_min_toas_per_backend_tim = 10

# 3) TIM hygiene
fix_dedupe_toas_within_tim = true
fix_check_duplicate_backend_tims = true
fix_remove_overlaps_exact = true

# 4) Ensure minimal required flags exist on every TOA line (adds only if missing)
#    (Keep this conservative; -sys/-group inference handles the smart stuff.)
fix_required_tim_flags = { "-pta" = "EPTA" }

# 5) Smart system flag inference (-sys/-group/-pta), and overwrite existing values
fix_infer_system_flags = true
fix_system_flag_overwrite_existing = true
fix_raise_on_backend_missing = false
# If you have oddball tim basenames that donâ€™t map cleanly, override them here:
# fix_backend_overrides = { "some_backend.tim" = "BACKEND_NAME" }

# 6) Parfile maintenance: ensure JUMPs exist for every unique -sys value across tims
fix_insert_missing_jumps = true
fix_jump_flag = "-sys"

# Optional (only set these if you actually want to enforce them globally):
# fix_ensure_ephem = "DE440"
# fix_ensure_clk = "TT(BIPM2021)"
# fix_ensure_ne_sw = "0"

# Coordinate conversion is risky to "force" blindly; enable only if you know your parfiles' frame.
# Allowed: "equ2ecl" or "ecl2equ"
# fix_coord_convert = "ecl2equ"

# ---- Optional reports / plots ----
make_toa_coverage_plots = true
make_outlier_reports = true
make_covariance_heatmaps = true
make_residual_plots = true
make_binary_analysis = true

dpi = 150
max_covmat_params = 60
binary_only_models = []  # e.g. ["ELL1","BTX"] to filter


