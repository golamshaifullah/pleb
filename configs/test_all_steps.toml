# TEST CONFIG: turns on every pipeline stage + FixDataset + QC (best-effort).
# Edit the 4 paths below. Keep quotes around strings/paths (TOML requirement).

home_dir = "/work/git_projects/data-eptadr3/"
dataset_name = "DR3full"
results_dir = "results"
singularity_image = "/work/git_projects/PSR_Singularity/psrpta.sif"
outdir_name = "run_fixdataset_all_fixes"
pulsars = "ALL"

# Run everything
run_tempo2 = true
force_rerun = true
run_fix_dataset=true
no_tempo2 = false
jobs = 16
epoch = 58000

# Comparison / reports (if your pipeline supports these)
branches = ["main", "fixdataset_test_5"]
reference_branch = "main"
make_change_reports = true

# QC (turn on + common knobs)
run_pqc = true

pqc_backend_col = "group"
pqc_drop_unmatched = true
qc_report = true
qc_report_backend_col = "group"
qc_report_no_plots = false
qc_report_structure_group_cols = "group;sys;freq_bin"
qc_report_no_feature_plots = false

pqc_add_orbital_phase = true
pqc_add_solar_elongation = true
pqc_add_elevation = true
pqc_add_airmass = true
pqc_add_parallactic_angle = true
pqc_add_freq_bin = true
pqc_freq_bins = 20

pqc_structure_mode = "both"
pqc_structure_detrend_features = ["solar_elongation_deg", "orbital_phase", "freq_bin"]
pqc_structure_test_features = ["orbital_phase", "solar_elongation_deg", "freq_bin"]
pqc_structure_nbins = 20
pqc_structure_min_per_bin = 2
pqc_structure_p_thresh = 0.01
pqc_structure_circular_features = ["orbital_phase"]
pqc_structure_group_cols = ["sys"]
pqc_outlier_gate_enabled = true
pqc_outlier_gate_sigma = 3.0
pqc_event_instrument = true


# QC -> FixDataset application (comment out by default)
fix_qc_remove_outliers = false
fix_qc_action = "comment"
fix_qc_comment_prefix = "C QC_OUTLIER"
fix_qc_remove_bad = true
fix_qc_remove_transients = false
fix_qc_merge_tol_days = 2.3148148148148147e-05
#2.0 / 86400.0
# If you want to point to a specific run, set these:
fix_qc_results_dir = "results/run_fixdataset_all_fixes/main-fixdataset_test_5/qc"
fix_qc_branch = "fixdataset_test_5"


# ---- FixDataset APPLY + COMMIT ----
# These are the settings that should force the apply path (branch + commit) if your pipeline.py supports it.
fix_apply = true
fix_branch_name = "fixdataset_test_5"
fix_base_branch = "main"
fix_commit_message = "TEST: apply FixDataset fixes"

# FixDataset switches (enable the usual “do work” actions)
fix_backup = false
fix_dry_run = false
fix_remove_patterns = ["NRT.NUPPI.", "NRT.NUXPI."]
fix_update_alltim_includes = true
fix_min_toas_per_backend_tim = 10
fix_dedupe_toas_within_tim = true
fix_check_duplicate_backend_tims = true
fix_remove_overlaps_exact = true
fix_required_tim_flags = { "-pta" = "EPTA" }
fix_infer_system_flags = true
fix_system_flag_overwrite_existing = true
fix_raise_on_backend_missing = false
fix_insert_missing_jumps = true
fix_jump_flag = "-sys"

# Plots / extras (if supported)
make_toa_coverage_plots = true
make_outlier_reports = true
make_covariance_heatmaps = true
make_residual_plots = true
make_binary_analysis = true

dpi = 150

pqc_delta_chi2_thresh = 10000.0
pqc_step_enabled = true
pqc_step_min_points = 20
pqc_step_delta_chi2_thresh = 25.0
pqc_step_scope = "both"

pqc_dm_step_enabled = true
pqc_dm_step_min_points = 20
pqc_dm_step_delta_chi2_thresh = 25.0
pqc_dm_step_scope = "both"

pqc_robust_enabled = true
pqc_robust_z_thresh = 2.0
pqc_robust_scope = "both"
